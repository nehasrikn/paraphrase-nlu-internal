<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>

<link href = "https://code.jquery.com/ui/1.12.1/themes/ui-lightness/jquery-ui.css" rel="stylesheet">

<style>
	body {
		padding: 10px;
		margin-bottom: 10px;
		font: Roboto;
	}
	.first-container{
	    display: flex;
	    justify-content: space-around;
	   	width: 1300px;
	   	padding: 10px;
	   	background-color: #e1f0f0;
	   	border-radius: 25px;
	}
	.left-container {
			float: left;
			width: 25%;
			text-align: center;
			overflow: scroll;
			padding: 5px;
	}
	.middle-container {
			float: left;
			width: 50%;
			overflow: scroll;
			text-align: center;
			padding-left: 10px;
			padding-right: 20px;
	}
	.right-container {
			float: left;
			width: 25%;
			padding-left: 10px;
			text-align: center;
			overflow: scroll;
			padding: 5px;
	}
	.card {
		margin: 10px;
		width: 250px;
		overflow-wrap: break-word;
	}

	.crowd-card {
    width: 100%;
  }

	.collapsible {
	  background-color:  #ccc;
	  color: #444;
	  cursor: pointer;
	  padding: 5px;
	  width: 50%;
	  border: none;
	  text-align: left;
	  outline: none;
	  font-size: 20px;
	  height:30px;
	  border-radius: 12px;
	}

	/* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
	.active, .collapsible:hover {
	  background-color: #ccc;
	}

	/* Style the collapsible content. Note: hidden by default */
	.content {
	  padding: 0 18px;
	  background-color: #f1f1f1;
	  max-height: 0px;
	  overflow: hidden;
	  transition: max-height 0.2s ease-out;
	  width: 75%;
	  border-radius: 25px;
	}
	.collapsible:after {
	  content: '\02795'; /* Unicode character for "plus" sign (+) */
	  font-size: 13px;
	  color: white;
	  float: right;
	  margin-left: 5px;
	}

	.active:after {
	  content: "\2796"; /* Unicode character for "minus" sign (-) */
	}

</style>

<crowd-form onsubmit="verifyHIT();">
	<div>
		<button id="coll_button" type="button" class="collapsible active" onload="clickCollapsible()"><b><u>Task Instructions</u></b></button>
		<div class="content" style="max-height: 1200px !important; height: auto;">
			<br>
			<b><u>Instructions:</b></u><br>
			Are machines sensitive to paraphrasing? Ideally, when machines are presented with two snippets of text that convey the same meaning yet utilize different words, they should behave in a similar way. In this HIT, weâ€™ll present a simple story, and your task will be to paraphrase the middle portion of it (i.e use different words to convey the same meaning).
			<br><br>
		</div>
	<br>
	<!-- ALL DATA -->
	
	<script>
		var coll = document.getElementsByClassName("collapsible");
		var i;

		for (i = 0; i < coll.length; i++) {
		  coll[i].addEventListener("click", function() {
		    this.classList.toggle("active");
		    var content = this.nextElementSibling;
		    if (content.style.maxHeight){
		      content.style.maxHeight = null;
		    } else {
		      content.style.maxHeight = content.scrollHeight + "px";
		    }
		  });
		}

		function verifyTaskCompleted(num_paraphrases){
			var entries = document.querySelectorAll("[id*=paraphrase_]")
			var paraphrases = new Set()

			for (var i = 0; i < entries.length; i++){ 
				if(entries[i].value.trim() === ""){
					errorBox.innerHTML = '<crowd-alert type="error" dismissible>Please finish filling out all paraphrases!</crowd-alert>';
					return false
				}
				const para = cleanAndStripPunctutation(entries[i].value)
				paraphrases.add(para)
				if(para.length <= 10){
					errorBox.innerHTML = '<crowd-alert type="error" dismissible>At least one of your paraphrases is too short. Please make sure your paraphrases are valid!</crowd-alert>';
					return false
				}
			}
			if (paraphrases.size != entries.length){
				errorBox.innerHTML = '<crowd-alert type="error" dismissible>Please make sure that all your paraphrases are unique (no duplicates allowed)!</crowd-alert>';
				return false
			}

			var similarities = document.querySelectorAll("[id*=similarity_]")
			for (var i = 0; i < similarities.length; i++){ 
				if(parseInt(similarities[i].textContent.slice(0, -1)) == 0){
					errorBox.innerHTML = '<crowd-alert type="error" dismissible>At least one of your paraphrases is a copy of the sentence you were supposed to paraphrase. Please <b>paraphrase</b> the sentence.</crowd-alert>';
					return false
				}
			}
  		return true;
		}

		function verifyHIT(){
	      if (!verifyTaskCompleted()) {
	          alert("Oh no! Something's wrong. Check the error below the submit button.");
	          event.preventDefault(); 
	      }
    }

    function cleanAndStripPunctutation(str) {
    	var cleanStr = str.toLowerCase().trim()
    	const regex = /[!"#$%&'()*+,-./:;<=>?@[\]^_`{|}~]/g;
    	return cleanStr.replace(regex, '')
    }

    function calculate_BLEU(free_text_id, similarity_id, original_sentence) {
    	//0 - 20 RED, 20 - 40 YELLOW, 40 - 100 GREEN

    	var freeText = document.getElementById(free_text_id);

    	const para_tokens = cleanAndStripPunctutation(freeText.value).split(' ')
    	const hyp_tokens = cleanAndStripPunctutation(original_sentence).split(' ')

    	var para_tokens_set = new Set(para_tokens)
    	var hyp_tokens_set = new Set(hyp_tokens)

    	intersection = new Set(para_tokens.filter(x=>hyp_tokens_set.has(x)) ),
		union = new Set(para_tokens.concat(hyp_tokens));  // This step is unnecessary but is for semantic illustration
		const jaccard_sim = intersection.size / union.size
		const distance = Math.round((1.0 - jaccard_sim) * 100)
		  
		document.getElementById(similarity_id).innerText = distance + '%';
		if (distance <= 20) {
			document.getElementById(similarity_id).style.color = "#C84327";
		} else if (distance > 20 && distance <= 40) {
			document.getElementById(similarity_id).style.color = "#ccb00a";
		} else {
			document.getElementById(similarity_id).style.color = "green";
		}

    }

	</script>
</crowd-form>
