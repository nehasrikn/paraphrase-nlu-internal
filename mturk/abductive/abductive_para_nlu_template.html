<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>

<link href = "https://code.jquery.com/ui/1.12.1/themes/ui-lightness/jquery-ui.css" rel="stylesheet">

<style>
	body {
		padding: 10px;
		margin-bottom: 10px;
		font: Roboto;
	}
	.first-container{
	    display: flex;
	    justify-content: space-around;
	   	width: 1300px;
	   	padding: 10px;
	   	background-color: #e1f0f0;
	   	border-radius: 25px;
	}
	.left-container {
			float: left;
			width: 25%;
			text-align: center;
			overflow: scroll;
			padding: 5px;
	}
	.middle-container {
			float: left;
			width: 50%;
			overflow: scroll;
			text-align: center;
			padding-left: 10px;
			padding-right: 20px;
	}
	.right-container {
			float: left;
			width: 25%;
			padding-left: 10px;
			text-align: center;
			overflow: scroll;
			padding: 5px;
	}
	.card {
		margin: 10px;
		width: 250px;
		overflow-wrap: break-word;
	}

	.crowd-card {
    width: 100%;
  }

	.collapsible {
	  background-color:  #ccc;
	  color: #444;
	  cursor: pointer;
	  padding: 5px;
	  width: 50%;
	  border: none;
	  text-align: left;
	  outline: none;
	  font-size: 20px;
	  height:30px;
	  border-radius: 12px;
	}

	/* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
	.active, .collapsible:hover {
	  background-color: #ccc;
	}

	/* Style the collapsible content. Note: hidden by default */
	.content {
	  padding: 0 18px;
	  background-color: #f1f1f1;
	  max-height: 0px;
	  overflow: hidden;
	  transition: max-height 0.2s ease-out;
	  width: 75%;
	  border-radius: 25px;
	}
	.collapsible:after {
	  content: '\02795'; /* Unicode character for "plus" sign (+) */
	  font-size: 13px;
	  color: white;
	  float: right;
	  margin-left: 5px;
	}

	.active:after {
	  content: "\2796"; /* Unicode character for "minus" sign (-) */
	}

</style>

<crowd-form onsubmit="verifyHIT();">
	<div>
		<button id="coll_button" type="button" class="collapsible active" onload="clickCollapsible()"><b><u>Collecting Paraphrases of Simple Stories: Task Instructions</u></b></button>
		<div class="content" style="max-height: 1800px !important; height: auto;">
			<br>
			<b><u>Instructions:</b></u><br>
			<br>
			<i>"Josh bought a parrot as a pet. The parrot repeated Josh's morning greeting. Josh was so excited that he taught his parrot how to say its name!"</i>
			<br><br>
			Are AI systems that are built to understand stories (like the one above) sensitive to word choice or sentence structure?
			<br><br>

			Ideally, when AI systems are presented with two snippets of text that convey the same meaning yet utilize different words or have different sentence structure, they should behave in a similar way. In this HIT, we’ll present a simple story consisting of 3 sentences, and your task will be to write paraphrases for a portion of it (i.e use different words or sentence structure to convey the same meaning).

			<br><br>

			Each story consists of a <u>beginning sentence</u>, <u>an ending sentence</u>, and a <u>middle sentence</u> that is either plausible or implausible (one each tab in the middle of the HIT). Plausible middle sentences make sense within the flow and context of the story, and implausible middle sentences do not necessarily fit within the flow of the story. The middle sentence in the story presented at the beginning is an example of a plausible middle sentence. However, an implausible middle sentence would be <i>"The parrot could not repeat Josh's greetings"</i>, since it does not align with the beginning and end sentences. 

			<br><br>

			Your task is to provide <u>three</u> paraphrases for both middle sentences (one on each tab) such that the words or sentence structure substantially differ from the original sentence, but the meaning is retained.

			<br><br>
			Your paraphrases should: <br>
			<ul>
				<li><b>Be full, grammatical, coherent sentences.</b></li>
				<li><b>Preserve the meaning of the sentence.</b></li>
				<ul>
					<li><i><u>Make sure that sentence <b>meaning</b> does not differ</u></i> from the original sentence.</li>
					<li><i><u>Refrain from introducing new information</u></i> that violates the situation evoked by the story.
					<li><i><u>Preserve plausibility.</u></i> If the sentence is labeled as "plausible", your paraphrase should still be plausible within the context of the story. If the sentence is labeled as "implausible" (i.e, it doesn’t make sense within the context of the story), make sure that your paraphrase retains this property.
				</ul>
				<li><b>Be as different as possible from the other paraphrases you enter.</b></li>
				<li><b>Differ as much as possible from the original sentence.</b>
				<ul>
					<li>Reduce word overlap between the original sentence and your paraphrased version.</li>
					<li> The HIT UI includes a calculator to measure the distance between your paraphrase and the original sentence via word overlap (# of words in common with the original sentence). The higher this value is, the better! <b>You don't need to achieve a distance measure of 100% in your paraphrases</b> (since you might use words like "be", or use common proper nouns), but aim to keep this metric above 40%!) We indicate this ideal range with <span style="color:green">green (40%+)</span>, <span style="color:#ccb00a">yellow (20%-40%)</span>, and <span style="color: #C84327">red (0%-20%)</span> coloring. </li>
				</ul>
			</ul>
			<h4><u>UI Instructions:</u></h4>
			<br>
			<img style="margin-top:-1em;" src="https://drive.google.com/uc?export=view&id=1Lc_0jIitGBVJEEjlvAXkyraJxxmSGjbo" width="100%" height="auto">
			<h4><u>Example:</u></h4>
			<br>
			<img style="margin-top:-1em;" src="https://drive.google.com/uc?export=view&id=1qmzhs2UIdYa1U-CA2mzn2zapORXq_nNy" width="100%" height="auto">
			<br><br>
		</div>
	<br>
	<!-- ALL DATA -->
	
	<script>
		var coll = document.getElementsByClassName("collapsible");
		var i;

		for (i = 0; i < coll.length; i++) {
		  coll[i].addEventListener("click", function() {
		    this.classList.toggle("active");
		    var content = this.nextElementSibling;
		    if (content.style.maxHeight){
		      content.style.maxHeight = null;
		    } else {
		      content.style.maxHeight = content.scrollHeight + "px";
		    }
		  });
		}

		function verifyTaskCompleted(num_paraphrases){
			var entries = document.querySelectorAll("[id*=paraphrase_]")
			var paraphrases = new Set()

			for (var i = 0; i < entries.length; i++){ 
				if(entries[i].value.trim() === ""){
					errorBox.innerHTML = '<crowd-alert type="error" dismissible>Please finish filling out all paraphrases!</crowd-alert>';
					return false
				}
				const para = cleanAndStripPunctutation(entries[i].value)
				paraphrases.add(para)
				if(para.length <= 10){
					errorBox.innerHTML = '<crowd-alert type="error" dismissible>At least one of your paraphrases is too short. Please make sure your paraphrases are valid!</crowd-alert>';
					return false
				}
			}
			if (paraphrases.size != entries.length){
				errorBox.innerHTML = '<crowd-alert type="error" dismissible>Please make sure that all your paraphrases are unique (no duplicates allowed)!</crowd-alert>';
				return false
			}

			var similarities = document.querySelectorAll("[id*=similarity_]")
			for (var i = 0; i < similarities.length; i++){ 
				if(parseInt(similarities[i].textContent.slice(0, -1)) == 0){
					errorBox.innerHTML = '<crowd-alert type="error" dismissible>At least one of your paraphrases is a copy of the sentence you were supposed to paraphrase. Please <b>paraphrase</b> the sentence.</crowd-alert>';
					return false
				}
			}
  		return true;
		}

		function verifyHIT(){
	      if (!verifyTaskCompleted()) {
	          alert("Oh no! Something's wrong. Check the error below the submit button.");
	          event.preventDefault(); 
	      }
    }

    function cleanAndStripPunctutation(str) {
    	var cleanStr = str.toLowerCase().trim()
    	const regex = /[!"#$%&'()*+,-./:;<=>?@[\]^_`{|}~]/g;
    	return cleanStr.replace(regex, '')
    }

    function calculate_BLEU(free_text_id, similarity_id, original_sentence) {
    	//0 - 20 RED, 20 - 40 YELLOW, 40 - 100 GREEN

    	var freeText = document.getElementById(free_text_id);

    	const para_tokens = cleanAndStripPunctutation(freeText.value).split(' ')
    	const hyp_tokens = cleanAndStripPunctutation(original_sentence).split(' ')

    	var para_tokens_set = new Set(para_tokens)
    	var hyp_tokens_set = new Set(hyp_tokens)

    	intersection = new Set(para_tokens.filter(x=>hyp_tokens_set.has(x)) ),
		union = new Set(para_tokens.concat(hyp_tokens));  // This step is unnecessary but is for semantic illustration
		const jaccard_sim = intersection.size / union.size
		const distance = Math.round((1.0 - jaccard_sim) * 100)
		  
		document.getElementById(similarity_id).innerText = distance + '%';
		if (distance <= 20) {
			document.getElementById(similarity_id).style.color = "#C84327";
		} else if (distance > 20 && distance <= 40) {
			document.getElementById(similarity_id).style.color = "#ccb00a";
		} else {
			document.getElementById(similarity_id).style.color = "green";
		}

    }

	</script>
</crowd-form>
